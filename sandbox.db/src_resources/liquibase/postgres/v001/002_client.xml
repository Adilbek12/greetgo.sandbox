<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet id="create-table-charm" author="adilbek">
    <sql endDelimiter=";;"><![CDATA[
      CREATE TABLE charm (
        id SERIAL PRIMARY KEY,
        name VARCHAR(255),
        description TEXT,
        energy FLOAT
      )
    ]]>
    </sql>
  </changeSet>


  <changeSet author="adilbek" id="create-table-client">
    <sql endDelimiter=";;"><![CDATA[
      CREATE TABLE client (
        id SERIAL,
        surname VARCHAR(255),
        name VARCHAR(255),
        patronymic VARCHAR(255),
        gender VARCHAR(255),
        birth_date DATE,
        charm INTEGER,
        actual SMALLINT NOT NULL DEFAULT 1,
        CONSTRAINT pk_tbl_Client_id PRIMARY KEY (id),
        FOREIGN KEY (charm) REFERENCES charm(id)
      );
    ]]></sql>
  </changeSet>

  <changeSet author="adilbek" id="create-table-client_phone">
    <sql endDelimiter=";;"><![CDATA[
      CREATE TABLE client_phone (
        client INTEGER,
        type VARCHAR(255),
        number VARCHAR(255),
        actual SMALLINT NOT NULL DEFAULT 1,
        PRIMARY KEY (client, number),
        FOREIGN KEY (client) REFERENCES client(id)
      )
    ]]></sql>
  </changeSet>

  <changeSet author="adilbek" id="create-table-client_address">
    <sql endDelimiter=";;"><![CDATA[
      CREATE TABLE client_address (
        client INTEGER,
        type VARCHAR(255),
        street VARCHAR(255),
        house VARCHAR(255),
        flat VARCHAR(255),
        PRIMARY KEY (client, type),
        actual SMALLINT NOT NULL DEFAULT 1,
        FOREIGN KEY (client) REFERENCES client(id)
      )
    ]]></sql>
  </changeSet>

  <changeSet id="create-table-client_account" author="adilbek">
    <sql endDelimiter=";;"><![CDATA[
      CREATE TABLE client_account (
        id SERIAL PRIMARY KEY,
        client INTEGER,
        money FLOAT,
        number VARCHAR(255),
        registered_at DATE,
        actual SMALLINT NOT NULL DEFAULT 1,
        FOREIGN KEY (client) REFERENCES client(id)
      )
    ]]>
    </sql>
  </changeSet>

  <changeSet id="create-function-insert_client" author="adilbek">
    <sql endDelimiter=";;"><![CDATA[
      CREATE FUNCTION insert_client(in_id integer, in_surname VARCHAR(255), in_name VARCHAR(255), in_patronymic VARCHAR(255),
      in_gender VARCHAR(255), in_birth_date DATE, in_charm INTEGER)
        RETURNS INTEGER
      AS
      $$
      BEGIN

      IF in_id IS NULL OR in_id < 0 THEN

        INSERT INTO client(surname, name, patronymic, gender, birth_date, charm)
        VALUES(in_surname, in_name, in_patronymic, in_gender, in_birth_date, in_charm)
        RETURNING id;

      ELSE

        UPDATE client SET
        surname=in_surname, name=in_name, patronymic=in_patronymic, gender=in_gender,
        birth_date=in_birth_date, charm=in_charm RETURNING id;

      END IF;
      RETURN(SELECT dblink_disconnect());
      END;
      $$
      LANGUAGE plpgsql;
    ]]>
    </sql>
  </changeSet>
</databaseChangeLog>